@page "/room/{Code}"
@implements IDisposable
@inject RoomManager RoomManager
@inject ParticipantSession Session
@inject IJSRuntime JS

<PageTitle>Room @Code</PageTitle>

@if (_room is null)
{
    <section class="card">
        <h1>Room not found</h1>
        <p>This room link is invalid or expired.</p>
        <a class="button" href="/">Return to lobby</a>
    </section>
}
else
{
    <div class="grid">
        <section class="card">
            <span class="badge">Freedom Hall</span>
            <h1>Room @Code</h1>
            <p class="muted">Democracy is in session. Share this link with friends to join and vote.</p>

            @if (!_isJoined)
            {
                <label class="field">
                    <span>Your display name</span>
                    <input @bind="_displayName" placeholder="Person A" />
                </label>
                <button class="button primary" @onclick="JoinRoomAsync" disabled="@string.IsNullOrWhiteSpace(_displayName)">Join room</button>
            }
            else
            {
                <div class="pill">Joined as <strong>@Session.Name</strong></div>
                <label class="field">
                    <span>Edit your display name</span>
                    <input @bind="_displayName" placeholder="Person A" />
                </label>
                <button class="button subtle" @onclick="UpdateNameAsync" disabled="@string.IsNullOrWhiteSpace(_displayName)">Update name</button>
            }

            <div class="section">
                <h2>Players</h2>
                <ul class="list">
                    @foreach (var participant in _room.Participants)
                    {
                        <li>
                            <span>@participant.Name</span>
                            <span class="status-chip">@participant.Status</span>
                        </li>
                    }
                </ul>
            </div>
        </section>

        <section class="card">
            <span class="badge">Ballot Box</span>
            <h1>Vote for a game</h1>
            <p>Each player can vote once. You can also vote for Random to let fate decide.</p>

            @if (!_isJoined)
            {
                <p class="muted">Join the room to cast your vote.</p>
            }
            else if (_room.Started)
            {
                var selectedVoters = GetSelectedVoters();
                <div class="result-panel">
                    <div class="result-header">
                        <span class="badge accent">Democracy decree</span>
                        <h2>@_room.SelectedGame</h2>
                        <p class="muted">@GetResultTagline(selectedVoters)</p>
                    </div>
                    <div class="vote-results">
                        <h3>How the citizens voted</h3>
                        <ul class="vote-list">
                            @foreach (var participant in _room.Participants)
                            {
                                <li class="vote-row">
                                    <div class="vote-person">
                                        <span class="vote-name">@participant.Name</span>
                                        <span class="vote-pill">@GetVoteDisplay(participant)</span>
                                    </div>
                                    <span class="vote-status">@participant.Status</span>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            }
            else
            {
                <div class="vote-grid">
                    @foreach (var option in _room.VoteOptions)
                    {
                        <label class="option @GetSelectedClass(option)">
                            <input type="radio" name="vote" value="@option" disabled="@_hasVoted" @onchange="() => SelectVote(option)" />
                            <span>@option</span>
                        </label>
                    }
                </div>

                <div class="section">
                    <button class="button primary" @onclick="ConfirmVote" disabled="@(!_canConfirmVote)">Confirm vote</button>
                    <span class="status">@_voteStatus</span>
                </div>

                <div class="section">
                    <button class="button primary" @onclick="StartRoom" disabled="@(!_room.AllVoted)">Start</button>
                </div>
            }
        </section>
    </div>
}

@code {
    [Parameter] public string Code { get; set; } = string.Empty;

    private RoomSnapshot? _room;
    private string _displayName = string.Empty;
    private bool _isJoined;
    private bool _hasVoted;
    private string _voteStatus = string.Empty;
    private string? _selectedVote;
    private bool _hasLoadedCookie;

    private const string NameCookieKey = "gc2-display-name";
    private const int NameCookieDays = 90;

    private bool _canConfirmVote => !_hasVoted && !string.IsNullOrWhiteSpace(_selectedVote);

    protected override void OnInitialized()
    {
        RoomManager.RoomUpdated += HandleRoomUpdated;
        LoadRoom();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _hasLoadedCookie)
        {
            return;
        }

        _hasLoadedCookie = true;
        var storedName = await JS.InvokeAsync<string>("gc2Cookies.get", NameCookieKey);
        if (!string.IsNullOrWhiteSpace(storedName))
        {
            _displayName = storedName;
            Session.Name = storedName;
            JoinRoomWithStoredName();
            LoadRoom();
            StateHasChanged();
        }
    }

    private void LoadRoom()
    {
        _room = RoomManager.GetRoom(Code);
        if (_room is null)
        {
            return;
        }

        if (!string.IsNullOrWhiteSpace(Session.Name))
        {
            _isJoined = true;
            var participant = _room.Participants.FirstOrDefault(p => p.Id == Session.Id);
            _hasVoted = participant?.HasVoted ?? false;
            _selectedVote = participant?.Vote ?? _selectedVote;
            _displayName = Session.Name ?? _displayName;
        }
    }

    private void HandleRoomUpdated(string code)
    {
        if (!string.Equals(code, Code, StringComparison.OrdinalIgnoreCase))
        {
            return;
        }

        InvokeAsync(() =>
        {
            LoadRoom();
            StateHasChanged();
        });
    }

    private async Task JoinRoomAsync()
    {
        if (_room is null || string.IsNullOrWhiteSpace(_displayName))
        {
            return;
        }

        Session.Name = _displayName.Trim();
        RoomManager.JoinRoom(Code, Session.Id, Session.Name);
        await JS.InvokeVoidAsync("gc2Cookies.set", NameCookieKey, Session.Name, NameCookieDays);
        _isJoined = true;
        _voteStatus = string.Empty;
    }

    private void JoinRoomWithStoredName()
    {
        if (_room is null || string.IsNullOrWhiteSpace(Session.Name))
        {
            return;
        }

        RoomManager.JoinRoom(Code, Session.Id, Session.Name);
        _isJoined = true;
    }

    private async Task UpdateNameAsync()
    {
        if (_room is null || string.IsNullOrWhiteSpace(_displayName))
        {
            return;
        }

        Session.Name = _displayName.Trim();
        RoomManager.JoinRoom(Code, Session.Id, Session.Name);
        await JS.InvokeVoidAsync("gc2Cookies.set", NameCookieKey, Session.Name, NameCookieDays);
        _voteStatus = "Name updated.";
    }

    private void SelectVote(string option)
    {
        if (_room is null || _hasVoted)
        {
            return;
        }

        _selectedVote = option;
        _voteStatus = "Vote ready to submit.";
    }

    private void ConfirmVote()
    {
        if (_room is null || _hasVoted || string.IsNullOrWhiteSpace(_selectedVote))
        {
            return;
        }

        RoomManager.CastVote(Code, Session.Id, _selectedVote);
        _hasVoted = true;
        _voteStatus = "Vote submitted.";
    }

    private void StartRoom()
    {
        if (_room is null)
        {
            return;
        }

        var selected = RoomManager.StartRoom(Code);
        if (!string.IsNullOrWhiteSpace(selected))
        {
            _voteStatus = $"Started with {selected}.";
        }
    }

    private string GetSelectedClass(string option)
    {
        if (_room is null)
        {
            return string.Empty;
        }

        var participant = _room.Participants.FirstOrDefault(p => p.Id == Session.Id);
        if (participant?.Vote == option)
        {
            return "selected";
        }

        if (!_hasVoted && string.Equals(_selectedVote, option, StringComparison.OrdinalIgnoreCase))
        {
            return "selected";
        }

        return string.Empty;
    }

    private IReadOnlyList<ParticipantSnapshot> GetSelectedVoters()
    {
        if (_room?.SelectedGame is null)
        {
            return Array.Empty<ParticipantSnapshot>();
        }

        return _room.Participants
            .Where(participant => string.Equals(participant.Vote, _room.SelectedGame, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private string GetResultTagline(IReadOnlyList<ParticipantSnapshot> voters)
    {
        if (_room?.SelectedGame is null)
        {
            return string.Empty;
        }

        if (voters.Count == 0)
        {
            return "Selected by the Random mandate â€” liberty for the unexpected.";
        }

        var voterNames = string.Join(", ", voters.Select(voter => voter.Name));
        var voterLabel = voters.Count == 1 ? "player" : "players";
        return $"Chosen by {voters.Count} {voterLabel}: {voterNames}.";
    }

    private static string GetVoteDisplay(ParticipantSnapshot participant)
    {
        return string.IsNullOrWhiteSpace(participant.Vote) ? "No vote" : participant.Vote!;
    }

    public void Dispose()
    {
        RoomManager.RoomUpdated -= HandleRoomUpdated;
    }
}
